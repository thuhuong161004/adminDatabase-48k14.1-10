--tạo dữ liệu bảng Phòng 
go
create or alter proc dumpPhong
as
begin
	declare @P_id INT=1,@P_sophong INT,@P_giaphong INT,@P_tinhtrangphong NVARCHAR(50) = 'ok'
	while @P_id <= 1000
		begin
			set @P_sophong = @P_id
			set @P_giaphong = CAST((RAND() * (1500000 - 1000000 + 1) + 1000000) AS INT)
			insert into Phong( P_id, P_sophong, P_giaphong , P_tinhtrangphong) values (@P_id ,@P_sophong ,@P_giaphong ,@P_tinhtrangphong)
			set @P_id = @P_id +1;

		end
end
exec dumpPhong
select * from Phong 


--1. Trả về giá phòng nếu biết id phòng 
go
create or alter function fgiaphong @idphong int 
returns int
as
begin
	declare @ret int 
	set @ret=(select P_giaphong  from Phong  where P_id=@idphong )
	return @ret
end



--2. Trả về thời gian thuê của khách hàng nếu biết mã phòng 
CREATE PROCEDURE sp_TinhThoiGianThue @maPhong INT
AS
BEGIN
    SELECT P_sophong AS SoPhong ,
           HD.HD_ngaybatdauThue AS NgayBatDau,
           HD.HD_thoihanThue AS NgayKetThuc,
           DATEDIFF(DAY, HD.HD_ngaybatdauThue, HD.HD_thoihanThue) AS SoNgayThue
    FROM Phong P
    JOIN HopDong HD ON P.P_id = HD.P_id   
    WHERE 
	P.P_id= @maPhong
END

--3.Kiểm tra khách thuê phòng gần nhất vào tháng mấy
CREATE PROCEDURE sp_KhachThueGanNhat
AS
BEGIN
    SELECT TOP 1 
           NTP_tenkhach AS TenKhachHang,
           MONTH(HD.HD_ngaybatdauThue) AS ThangThue
    FROM NguoiThuePhong NTP
    JOIN HopDong HD ON NTP.P_id = HD.P_id
    ORDER BY HD.HD_ngaybatdauThue DESC 
END








